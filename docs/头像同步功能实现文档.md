# 头像同步功能实现文档

## 实现日期
2026-02-11

## 需求描述

要求个人信息或账号的头像和登录时使用的头像保持同步，确保用户在不同页面看到的头像是一致的。

## 实现方案

### 数据流向

```
用户登录
    ↓
选择头像 + 输入昵称
    ↓
调用后端登录接口
    ↓
保存用户信息到 app.globalData.userInfo
    ↓
保存到本地缓存 wx.setStorageSync('userInfo', userInfo)
    ↓
各个页面从 app.getUserInfo() 获取头像和昵称
```

### 核心实现

#### 1. 登录时保存用户信息

**文件：** `pages/login/login.js`

**已实现：**
```javascript
loginToBackend(code) {
  wx.request({
    url: 'http://localhost:8080/api/user/login',
    method: 'POST',
    data: {
      code: code,
      nickname: this.data.nickName.trim(),
      avatar: this.data.avatarUrl  // ✅ 上传头像
    },
    success: (res) => {
      if (res.data.code === 200 && res.data.data) {
        const userInfo = res.data.data;

        // ✅ 保存用户信息到全局变量和本地缓存
        app.setUserInfo(userInfo);

        // 跳转到首页
        wx.reLaunch({ url: '/pages/index/index' });
      }
    }
  });
}
```

**userInfo 数据结构：**
```javascript
{
  id: 1,
  nickname: '张三',
  avatar: 'https://...',  // 微信头像 URL
  openid: 'xxx',
  // ... 其他字段
}
```

#### 2. App.js 全局管理

**文件：** `app.js`

**已实现：**
```javascript
App({
  globalData: {
    userInfo: null,
    userId: null
  },

  // 初始化时从本地缓存加载
  initApp() {
    const storedUser = wx.getStorageSync('userInfo');
    if (storedUser) {
      this.globalData.userInfo = storedUser;
      this.globalData.userId = storedUser.id;
    }
  },

  // 获取用户信息
  getUserInfo() {
    return this.globalData.userInfo;
  },

  // 设置用户信息
  setUserInfo(userInfo) {
    this.globalData.userInfo = userInfo;
    this.globalData.userId = userInfo.id;

    // 保存到本地缓存
    wx.setStorageSync('userInfo', userInfo);
    wx.setStorageSync('userId', userInfo.id);
  }
});
```

#### 3. 简历编辑页同步头像

**文件：** `pages/resume-make/resume-make.js`

**修改前：**
```javascript
loadUserBasic() {
  const resumeId = this.data.resumeId;
  if (!resumeId) return;

  // 只从后端加载简历信息
  api.getResumeDetail(resumeId)
    .then(res => {
      if (res.code === 200 && res.data) {
        const resume = res.data;
        this.setData({
          user: {
            name: resume.name || '',
            school: resume.school || '',
            degree: resume.education || '',
            gradYear: resume.graduationDate ? new Date(resume.graduationDate).getFullYear() : ''
          }
        });
      }
    });
}
```

**问题：**
- ❌ 没有加载头像
- ❌ 新建简历时没有默认昵称

**修改后：**
```javascript
loadUserBasic() {
  const resumeId = this.data.resumeId;
  if (!resumeId) return;

  // ✅ 先从登录信息中获取头像和昵称
  const app = getApp();
  const loginUserInfo = app.getUserInfo();

  // ✅ 设置登录用户的头像
  if (loginUserInfo && loginUserInfo.avatar) {
    this.setData({
      avatarPath: loginUserInfo.avatar
    });
  }

  // 从后端加载简历基本信息
  api.getResumeDetail(resumeId)
    .then(res => {
      if (res.code === 200 && res.data) {
        const resume = res.data;
        this.setData({
          user: {
            // ✅ 如果简历没有姓名，使用登录昵称
            name: resume.name || (loginUserInfo ? loginUserInfo.nickname : ''),
            school: resume.school || '',
            degree: resume.education || '',
            gradYear: resume.graduationDate ? new Date(resume.graduationDate).getFullYear() : ''
          }
        });
      } else {
        // ✅ 如果后端没有数据，使用登录信息
        if (loginUserInfo) {
          this.setData({
            user: {
              name: loginUserInfo.nickname || '',
              school: '',
              degree: '',
              gradYear: ''
            }
          });
        }
      }
    })
    .catch(err => {
      console.error('加载用户基本信息失败:', err);
      // ✅ 失败时也尝试使用登录信息
      if (loginUserInfo) {
        this.setData({
          user: {
            name: loginUserInfo.nickname || '',
            school: '',
            degree: '',
            gradYear: ''
          }
        });
      }
    });
}
```

**改进：**
1. ✅ 始终显示登录用户的头像
2. ✅ 新建简历时使用登录昵称作为默认值
3. ✅ 加载失败时也能显示登录信息
4. ✅ 优先使用简历数据，其次使用登录信息

#### 4. 基本信息编辑页同步昵称

**文件：** `pages/resume-basic-edit/resume-basic-edit.js`

**修改前：**
```javascript
loadData() {
  if (!this.data.resumeId) return;

  wx.showLoading({ title: '加载中...' });

  api.getResumeDetail(this.data.resumeId)
    .then(res => {
      wx.hideLoading();
      if (res.code === 200 && res.data) {
        this.setData({
          form: {
            name: res.data.name || '',
            // ... 其他字段
          }
        });
      }
    });
}
```

**问题：**
- ❌ 新建简历时姓名为空
- ❌ 没有使用登录昵称作为默认值

**修改后：**
```javascript
loadData() {
  if (!this.data.resumeId) {
    // ✅ 如果没有 resumeId，尝试使用登录信息作为默认值
    const app = getApp();
    const loginUserInfo = app.getUserInfo();
    if (loginUserInfo) {
      this.setData({
        form: {
          ...this.data.form,
          name: loginUserInfo.nickname || ''
        }
      });
    }
    return;
  }

  wx.showLoading({ title: '加载中...' });

  api.getResumeDetail(this.data.resumeId)
    .then(res => {
      wx.hideLoading();
      if (res.code === 200 && res.data) {
        this.setData({
          form: {
            name: res.data.name || '',
            // ... 其他字段
          }
        });
      } else {
        // ✅ 如果后端没有数据，使用登录信息作为默认值
        const app = getApp();
        const loginUserInfo = app.getUserInfo();
        if (loginUserInfo) {
          this.setData({
            form: {
              ...this.data.form,
              name: loginUserInfo.nickname || ''
            }
          });
        }
      }
    })
    .catch(err => {
      wx.hideLoading();
      console.error('加载失败:', err);
      // ✅ 失败时也尝试使用登录信息
      const app = getApp();
      const loginUserInfo = app.getUserInfo();
      if (loginUserInfo) {
        this.setData({
          form: {
            ...this.data.form,
            name: loginUserInfo.nickname || ''
          }
        });
      }
    });
}
```

**改进：**
1. ✅ 新建简历时使用登录昵称作为默认值
2. ✅ 加载失败时也能显示登录昵称
3. ✅ 优先使用简历数据，其次使用登录信息

#### 5. 个人中心页同步头像

**文件：** `pages/profile/profile.js`

**已正确实现：**
```javascript
loadUserInfo() {
  const userInfo = app.getUserInfo();

  if (userInfo) {
    // ✅ 从登录信息获取头像
    this.setData({
      user: {
        name: userInfo.nickname || '微信用户',
        school: userInfo.school || '未设置',
        degree: userInfo.education || '',
        gradYear: userInfo.graduationYear || '',
        gradDate: userInfo.graduationDate || '----'
      },
      avatarPath: userInfo.avatar || ''  // ✅ 显示登录头像
    });
  }
}
```

**确认：**
- ✅ 正确从 `app.getUserInfo()` 获取头像
- ✅ 显示登录时选择的头像

## 头像同步逻辑

### 优先级

1. **登录头像**（最高优先级）
   - 来源：用户登录时选择的微信头像
   - 存储：`app.globalData.userInfo.avatar`
   - 用途：所有页面的头像显示

2. **简历数据**（次优先级）
   - 来源：后端简历数据
   - 存储：后端数据库
   - 用途：简历基本信息（姓名、学校等）

3. **默认值**（最低优先级）
   - 来源：空字符串或占位符
   - 用途：没有任何数据时的显示

### 数据获取顺序

```javascript
// 1. 获取登录信息
const app = getApp();
const loginUserInfo = app.getUserInfo();

// 2. 设置头像（始终使用登录头像）
if (loginUserInfo && loginUserInfo.avatar) {
  this.setData({
    avatarPath: loginUserInfo.avatar
  });
}

// 3. 获取简历数据
api.getResumeDetail(resumeId)
  .then(res => {
    if (res.code === 200 && res.data) {
      // 使用简历数据
      this.setData({
        user: {
          name: res.data.name || loginUserInfo.nickname,  // 优先简历，其次登录
          school: res.data.school || '',
          // ...
        }
      });
    } else {
      // 使用登录信息
      this.setData({
        user: {
          name: loginUserInfo.nickname || '',
          school: '',
          // ...
        }
      });
    }
  });
```

## 用户体验

### 场景 1：新用户首次登录

```
1. 用户登录
   - 选择微信头像
   - 输入昵称"张三"

2. 创建简历
   - 头像：显示微信头像 ✅
   - 姓名：默认填充"张三" ✅

3. 编辑基本信息
   - 头像：显示微信头像 ✅
   - 姓名：默认填充"张三" ✅
   - 可以修改为真实姓名

4. 个人中心
   - 头像：显示微信头像 ✅
   - 昵称：显示"张三" ✅
```

### 场景 2：老用户已有简历

```
1. 用户登录
   - 头像：微信头像
   - 昵称："张三"

2. 查看简历
   - 头像：显示微信头像 ✅
   - 姓名：显示简历中的真实姓名"张三丰" ✅

3. 编辑基本信息
   - 头像：显示微信头像 ✅
   - 姓名：显示简历中的真实姓名"张三丰" ✅

4. 个人中心
   - 头像：显示微信头像 ✅
   - 昵称：显示"张三" ✅
```

### 场景 3：网络异常

```
1. 用户登录
   - 头像：微信头像
   - 昵称："张三"

2. 查看简历（网络异常）
   - 头像：显示微信头像 ✅（从本地缓存）
   - 姓名：显示"张三" ✅（从本地缓存）

3. 编辑基本信息（网络异常）
   - 头像：显示微信头像 ✅（从本地缓存）
   - 姓名：默认填充"张三" ✅（从本地缓存）
```

## 技术要点

### 1. 获取登录信息

```javascript
const app = getApp();
const loginUserInfo = app.getUserInfo();

// loginUserInfo 结构
{
  id: 1,
  nickname: '张三',
  avatar: 'https://...',
  openid: 'xxx',
  // ...
}
```

### 2. 设置头像

```javascript
// 在 data 中定义
data: {
  avatarPath: ''
}

// 设置头像
this.setData({
  avatarPath: loginUserInfo.avatar
});
```

### 3. WXML 显示头像

```xml
<view class="avatar">
  <image wx:if="{{avatarPath}}" class="avatar-img" src="{{avatarPath}}" mode="aspectFill" />
  <view wx:else class="avatar-placeholder">头像</view>
</view>
```

### 4. 默认值处理

```javascript
// 使用 || 运算符提供默认值
name: resume.name || loginUserInfo.nickname || ''

// 使用三元运算符
name: loginUserInfo ? loginUserInfo.nickname : ''
```

## 测试步骤

### 1. 测试登录头像

```
步骤：
1. 退出登录（如果已登录）
2. 进入登录页
3. 选择头像
4. 输入昵称
5. 点击登录

预期结果：
✅ 登录成功
✅ 头像和昵称保存到 app.globalData.userInfo
✅ 头像和昵称保存到本地缓存
```

### 2. 测试简历编辑页头像

```
步骤：
1. 登录后进入简历列表
2. 创建新简历
3. 进入简历编辑页

预期结果：
✅ 显示登录时选择的头像
✅ 姓名默认为登录昵称
```

### 3. 测试基本信息编辑页

```
步骤：
1. 在简历编辑页点击基本信息卡片
2. 进入基本信息编辑页

预期结果：
✅ 姓名默认为登录昵称（新建简历）
✅ 姓名显示简历数据（已有简历）
```

### 4. 测试个人中心头像

```
步骤：
1. 进入个人中心页

预期结果：
✅ 显示登录时选择的头像
✅ 显示登录昵称
```

### 5. 测试网络异常

```
步骤：
1. 断开网络
2. 重启小程序
3. 进入简历编辑页

预期结果：
✅ 从本地缓存加载头像
✅ 从本地缓存加载昵称
✅ 功能正常使用
```

## 注意事项

1. **头像来源统一**
   - 所有页面的头像都来自 `app.getUserInfo().avatar`
   - 不要从其他地方获取头像

2. **本地缓存**
   - 登录信息保存到本地缓存
   - 小程序重启后自动加载

3. **优先级处理**
   - 头像：始终使用登录头像
   - 姓名：优先简历数据，其次登录昵称

4. **错误处理**
   - 网络异常时使用本地缓存
   - 没有数据时显示占位符

5. **数据同步**
   - 登录后立即保存用户信息
   - 各页面从统一来源获取数据

## 总结

通过这次实现，我们完成了：

✅ **头像同步**：所有页面显示登录时选择的头像
✅ **昵称同步**：新建简历时使用登录昵称作为默认值
✅ **数据统一**：所有数据来自 `app.getUserInfo()`
✅ **本地缓存**：支持离线使用
✅ **错误处理**：网络异常时使用本地缓存
✅ **用户体验**：新用户无需重复输入信息

现在用户在不同页面看到的头像和昵称是一致的，提供了更好的用户体验。
