# 简历模块修复记录 - 硬编码清理

## 修复日期
2026-02-11

## 问题描述

### 问题 1：TypeError - ensureAtLeastOneResume is not a function

**现象：**
点击简历列表项时报错：`TypeError: this.ensureAtLeastOneResume is not a function`

**原因：**
在上一轮重构中删除了 `ensureAtLeastOneResume` 函数（因为改为后端主导模式），但 `onResumeTap` 方法中仍在调用该函数。

**影响范围：**
- `pages/resume/resume.js` 的 `onResumeTap` 方法

### 问题 2：硬编码默认数据

**现象：**
进入简历编辑页时，基本信息模块默认显示"管理员"、"江夏学院"、"本科"、"2023届"等测试数据。

**原因：**
`pages/resume-make/resume-make.js` 的 `data.user` 对象中硬编码了默认值。

**影响范围：**
- 简历编辑容器页的用户信息展示
- 用户体验（显示错误的默认信息）

## 修复内容

### 1. 修复 pages/resume/resume.js

#### 修改 onResumeTap 方法

**修改前：**
```javascript
onResumeTap(e) {
  if (this._suppressNextTap) {
    this._suppressNextTap = false;
    return;
  }

  const index = Number(e.currentTarget.dataset.index);
  const resumes = this.data.resumes || [];
  const safeResumes = this.ensureAtLeastOneResume(resumes);  // ❌ 调用已删除的函数
  const target = safeResumes[index];

  if (!target) return;

  this.navigateToResumeEdit(index);
}
```

**修改后：**
```javascript
onResumeTap(e) {
  if (this._suppressNextTap) {
    this._suppressNextTap = false;
    return;
  }

  const index = Number(e.currentTarget.dataset.index);
  const resumes = this.data.resumes || [];
  const target = resumes[index];  // ✅ 直接使用 resumes

  if (!target || !target.backendId) {  // ✅ 增加 backendId 校验
    wx.showToast({
      title: '简历数据异常',
      icon: 'none'
    });
    return;
  }

  this.navigateToResumeMakeByIndex(index);  // ✅ 使用正确的方法名
}
```

**改动说明：**
1. 移除 `ensureAtLeastOneResume` 调用，直接使用 `this.data.resumes`
2. 增加 `backendId` 有效性校验
3. 修正方法调用名称

### 2. 修复 pages/resume-make/resume-make.js

#### 2.1 清除硬编码默认值

**修改前：**
```javascript
data: {
  resumeId: null,
  resumeName: '我的简历1',
  completion: 0,
  completionAnim: 0,
  editingName: false,
  nameDraft: '',
  user: {
    name: '管理员',        // ❌ 硬编码
    school: '江夏学院',    // ❌ 硬编码
    degree: '本科',        // ❌ 硬编码
    gradYear: '2023'       // ❌ 硬编码
  },
  avatarPath: '',
  sections: [...],
  educationList: []
},
```

**修改后：**
```javascript
data: {
  resumeId: null,
  resumeName: '我的简历1',
  completion: 0,
  completionAnim: 0,
  editingName: false,
  nameDraft: '',
  user: {
    name: '',        // ✅ 空字符串
    school: '',      // ✅ 空字符串
    degree: '',      // ✅ 空字符串
    gradYear: ''     // ✅ 空字符串
  },
  avatarPath: '',
  sections: [...],
  educationList: []
},
```

#### 2.2 改造 loadUserBasic 方法

**修改前：**
```javascript
loadUserBasic() {
  const basic = wx.getStorageSync('profile_basic_info') || {};
  const defaults = this.data.user || {};
  const name = basic.name || defaults.name;        // ❌ 使用硬编码默认值
  const school = basic.school || defaults.school;  // ❌ 使用硬编码默认值
  const degree = basic.degree || defaults.degree;  // ❌ 使用硬编码默认值
  const gradYear = basic.gradYear || defaults.gradYear;  // ❌ 使用硬编码默认值

  this.setData({
    user: {
      name,
      school,
      degree,
      gradYear
    },
    avatarPath: basic.avatarPath || ''
  });
}
```

**修改后：**
```javascript
loadUserBasic() {
  const resumeId = this.data.resumeId;
  if (!resumeId) {
    return;
  }

  // ✅ 从后端加载简历基本信息
  api.getResumeDetail(resumeId)
    .then(res => {
      if (res.code === 200 && res.data) {
        const resume = res.data;
        this.setData({
          user: {
            name: resume.name || '',
            school: resume.school || '',
            degree: resume.education || '',
            gradYear: resume.graduationDate ? new Date(resume.graduationDate).getFullYear() : ''
          }
        });
      }
    })
    .catch(err => {
      console.error('加载用户基本信息失败:', err);
    });
}
```

**改动说明：**
1. 移除本地存储读取逻辑
2. 改为从后端 API 加载数据
3. 只在 `resumeId` 有效时才加载
4. 数据来源统一为后端数据库

#### 2.3 修复 goToProfileEdit 方法

**修改前：**
```javascript
goToProfileEdit() {
  wx.navigateTo({
    url: '/pages/profile-edit/profile-edit'  // ❌ 跳转到错误的页面
  });
}
```

**修改后：**
```javascript
goToProfileEdit() {
  const resumeId = this.data.resumeId;
  if (!resumeId) {
    wx.showToast({
      title: '简历ID无效',
      icon: 'none'
    });
    return;
  }

  wx.navigateTo({
    url: `/pages/resume-basic-edit/resume-basic-edit?id=${resumeId}`  // ✅ 跳转到正确的页面并传递 ID
  });
}
```

**改动说明：**
1. 跳转到正确的简历基本信息编辑页
2. 传递 `resumeId` 参数
3. 增加 ID 有效性校验

### 3. 验证 pages/resume-basic-edit/resume-basic-edit.js

**确认该文件已正确实现：**

```javascript
data: {
  resumeId: null,
  form: {
    name: '',              // ✅ 空字符串
    gender: '',            // ✅ 空字符串
    birthDate: '',         // ✅ 空字符串
    phone: '',             // ✅ 空字符串
    email: '',             // ✅ 空字符串
    education: '',         // ✅ 空字符串
    school: '',            // ✅ 空字符串
    major: '',             // ✅ 空字符串
    graduationDate: '',    // ✅ 空字符串
    jobIntention: '',      // ✅ 空字符串
    expectedCity: '',      // ✅ 空字符串
    expectedSalary: ''     // ✅ 空字符串
  },
  genderOptions: ['男', '女'],
  educationOptions: ['高中', '专科', '本科', '硕士', '博士'],
  statusBarHeight: 0
},

onLoad(options) {
  const sys = wx.getSystemInfoSync();
  this.setData({
    statusBarHeight: sys.statusBarHeight || 0,
    resumeId: parseInt(options.id)
  });

  this.loadData();  // ✅ 只在有 resumeId 时加载数据
},

loadData() {
  if (!this.data.resumeId) return;  // ✅ 校验 ID

  wx.showLoading({ title: '加载中...' });

  api.getResumeDetail(this.data.resumeId)  // ✅ 从后端加载
    .then(res => {
      wx.hideLoading();
      if (res.code === 200 && res.data) {
        this.setData({
          form: {
            name: res.data.name || '',
            gender: res.data.gender || '',
            // ... 其他字段
          }
        });
      }
    })
    .catch(err => {
      wx.hideLoading();
      console.error('加载失败:', err);
    });
}
```

**该文件无需修改，已符合要求：**
- ✅ 初始化时所有字段都是空字符串
- ✅ 只在 `resumeId` 存在时才加载数据
- ✅ 数据来源为后端 API
- ✅ 没有硬编码的默认值

## 数据流向

### 修复前（错误）

```
用户点击简历
    ↓
onResumeTap 调用 ensureAtLeastOneResume  ← ❌ 函数不存在
    ↓
报错：TypeError
```

```
进入简历编辑页
    ↓
显示硬编码数据：
  - 姓名：管理员
  - 学校：江夏学院
  - 学历：本科
  - 届别：2023届
    ↓
用户困惑：为什么显示错误的信息？
```

### 修复后（正确）

```
用户点击简历
    ↓
onResumeTap 直接使用 this.data.resumes[index]
    ↓
校验 backendId 有效性
    ↓
跳转到编辑页（传递 resumeId）
```

```
进入简历编辑页
    ↓
初始化：所有字段为空字符串
    ↓
onLoad 获取 resumeId
    ↓
loadUserBasic 调用 api.getResumeDetail(resumeId)
    ↓
显示后端返回的真实数据
    ↓
如果是新建简历，显示空表单
```

## 用户体验改进

### 1. 新建简历

**修复前：**
- 显示"管理员"、"江夏学院"等错误信息
- 用户需要手动清除这些数据

**修复后：**
- 显示空表单
- 用户直接输入真实信息

### 2. 编辑简历

**修复前：**
- 可能显示硬编码数据而不是真实数据
- 数据来源混乱（本地存储 + 硬编码）

**修复后：**
- 显示后端数据库中的真实数据
- 数据来源统一（后端 API）

### 3. 错误处理

**修复前：**
- 点击简历直接报错
- 没有友好的错误提示

**修复后：**
- 增加 ID 有效性校验
- 显示友好的错误提示
- 数据异常时提示用户

## 测试建议

### 1. 测试新建简历

```
步骤：
1. 进入简历列表页
2. 点击"新增简历"
3. 创建成功后进入编辑页
4. 点击基本信息卡片

预期结果：
- 所有字段应该为空
- 不应该显示"管理员"、"江夏学院"等数据
```

### 2. 测试编辑简历

```
步骤：
1. 进入简历列表页
2. 点击已有的简历
3. 进入编辑页
4. 点击基本信息卡片

预期结果：
- 应该显示该简历的真实数据
- 数据应该来自后端数据库
```

### 3. 测试点击简历

```
步骤：
1. 进入简历列表页
2. 点击任意简历

预期结果：
- 不应该报错
- 应该正常跳转到编辑页
```

### 4. 测试数据异常

```
步骤：
1. 清除本地存储
2. 手动构造一个没有 backendId 的简历数据
3. 点击该简历

预期结果：
- 显示"简历数据异常"提示
- 不会跳转
```

## 注意事项

1. **不要使用硬编码默认值**
   - 所有字段初始化为空字符串
   - 数据必须来自后端 API

2. **严格校验 ID**
   - 所有操作前都要校验 `resumeId` 或 `backendId`
   - ID 无效时要提示用户

3. **统一数据来源**
   - 不要混用本地存储和后端数据
   - 采用后端主导模式

4. **友好的错误提示**
   - 数据异常时要明确提示
   - 不要让用户看到技术错误信息

## 总结

通过这次修复，我们解决了：

✅ **TypeError 错误**：移除了对已删除函数的调用
✅ **硬编码数据**：清除了所有测试数据，改为从后端加载
✅ **数据来源统一**：所有数据都来自后端 API
✅ **用户体验**：新建简历显示空表单，编辑简历显示真实数据
✅ **错误处理**：增加了完善的 ID 校验和错误提示

现在简历模块的数据流向清晰、逻辑正确，用户体验得到了显著改善。
